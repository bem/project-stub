/**
 * @module popup
 */

modules.define(
    'sitemap',
    ['i-bem-dom'],
    function(provide, bemDom) {

        var ZINDEX_FACTOR = 1000,
            visiblePopupsZIndexes = {},
            undef;

        /**
         * @exports
         * @class popup
         * @bem
         *
         * @param {Number} [zIndexGroupLevel=0] z-index group level
         *
         * @bemmod visible Represents visible state
         */
        provide(bemDom.declBlock(this.name, /** @lends popup.prototype */{
            onSetMod : {
                'js' : {
                    'inited' : function() {
                        this._parentPopup = undef;
                        this._zIndex = null;
                        this._zIndexGroupLevel = null;
                        this._isAttachedToScope = false;
                    },

                    '' : function() {
                        this.delMod('visible');
                    }
                },

                'visible' : {
                    'true' : function() {
                        if(!this._isAttachedToScope) {
                            bemDom.scope.append(this.domElem);
                            this._isAttachedToScope = true;
                        }

                        this
                            ._captureZIndex()
                            ._bindToParentPopup()
                            ._domEvents().on('pointerpress pointerclick', this._setPreventHideByClick);

                        this.domElem.removeAttr('aria-hidden');
                    },

                    '' : function() {
                        this
                            ._releaseZIndex()
                            ._unbindFromParentPopup()
                            ._domEvents().un('pointerpress pointerclick', this._setPreventHideByClick);

                        this.domElem.attr('aria-hidden', true);
                    }
                }
            },

            /**
             * Sets content
             * @param {String|jQuery} content
             * @returns {popup} this
             */
            setContent : function(content) {
                bemDom.update(this.domElem, content);
                return this;
            },

            _calcZIndexGroupLevel : function() {
                var res = this.params.zIndexGroupLevel,
                    parentPopup = this._getParentPopup();

                parentPopup && (res += parentPopup._zIndexGroupLevel);

                return res;
            },

            _setPreventHideByClick : function() {
                var curPopup = this;
                do {
                    curPopup._preventHideByClick = true;
                } while(curPopup = curPopup._getParentPopup());
            },

            _bindToParentPopup : function() {
                var parentPopup = this._getParentPopup();
                parentPopup &&
                this._events(parentPopup).on({ modName : 'visible', modVal : '' }, this._onParentPopupHide, this);

                return this;
            },

            _unbindFromParentPopup : function() {
                this._parentPopup && this._events(this._parentPopup)
                    .un({ modName : 'visible', modVal : '' }, this._onParentPopupHide, this);

                this._parentPopup = undef;

                return this;
            },

            _onParentPopupHide : function() {
                this.delMod('visible');
            },

            _getParentPopup : function() {
                return this._parentPopup;
            },

            _captureZIndex : function() {
                var level = this._zIndexGroupLevel === null?
                        this._zIndexGroupLevel = this._calcZIndexGroupLevel() :
                        this._zIndexGroupLevel,
                    zIndexes = visiblePopupsZIndexes[level] || (visiblePopupsZIndexes[level] = [(level + 1) * ZINDEX_FACTOR]),
                    prevZIndex = this._zIndex;

                this._zIndex = zIndexes[zIndexes.push(zIndexes[zIndexes.length - 1] + 1) - 1];
                this._zIndex !== prevZIndex && this.domElem.css('z-index', this._zIndex);

                return this;
            },

            _releaseZIndex : function() {
                var zIndexes = visiblePopupsZIndexes[this._zIndexGroupLevel];
                zIndexes.splice(zIndexes.indexOf(this._zIndex), 1);

                return this;
            },

            _recaptureZIndex : function() {
                this._releaseZIndex();
                this._zIndexGroupLevel = null;

                return this._captureZIndex();
            },

            _getDefaultParams : function() {
                return {
                    zIndexGroupLevel : 0
                };
            }
        }, /** @lends popup */{
            lazyInit : true
        }));

    });